# https://grafana.com/docs/grafana/latest/administration/provisioning/#alerting
# https://grafana.com/docs/grafana/latest/alerting/set-up/provision-alerting-resources/file-provisioning
apiVersion: 1

deleteContactPoints:
  - orgId: 1
    name: grafana-default-email

contactPoints:
  - orgId: 1
    name: blackhole
    receivers:
      - uid: blackhole_receiver
        type: email
        disableResolveMessage: true
        settings:
          addresses: blackhole@localhost

  - orgId: 1
    name: telegram_default
    receivers:
      - uid: telegram_default_receiver
        type: telegram
        settings:
          bottoken: ${GRAFANA_TELEGRAM_BOT_TOKEN}
          chatid: |
            $GRAFANA_TELEGRAM_CHAT_ID
          message: |
            {{ template "telegram.default" . }}
          parse_mode: HTML
          disable_web_page_preview: true

  - orgId: 1
    name: telegram_default_no_resolved
    receivers:
      - uid: telegram_no_resolved_receiver
        type: telegram
        disableResolveMessage: true
        settings:
          bottoken: ${GRAFANA_TELEGRAM_BOT_TOKEN}
          chatid: |
            $GRAFANA_TELEGRAM_CHAT_ID
          message: |
            {{ template "telegram.default" . }}
          parse_mode: HTML
          disable_web_page_preview: true

  - orgId: 1
    name: telegram_home
    receivers:
      - uid: telegram_home_receiver
        type: telegram
        settings:
          bottoken: ${GRAFANA_TELEGRAM_BOT_TOKEN}
          chatid: |
            $GRAFANA_TELEGRAM_HOME_CHAT_ID
          message: |
            {{ template "telegram_home.default" . }}
          parse_mode: HTML
          disable_web_page_preview: true

policies:
  - orgId: 1
    receiver: blackhole
    group_by:
      - job
      - alertname
    group_wait: 15s
    group_interval: 15s
    repeat_interval: 24h
    routes:
      - receiver: telegram_default_no_resolved
        continue: false
        matchers:
          - env =~ "prod|dev"
          - severity = error
          - no_resolved = "true"

      - receiver: telegram_default
        continue: false
        matchers:
          - env =~ "prod|dev"
          - severity = error

      - receiver: telegram_home
        continue: false
        matchers:
          - env = telegram_home

templates:
  - orgId: 1
    name: telegram_default
    template: |
      {{ define "telegram.default" }}
      {{ range .Alerts }}
      <b>{{ .Labels.alertname }}</b>
      {{ if .Labels.severity }}<b>Severity:</b> {{ .Labels.severity }}{{ end }}
      {{ if .Labels.instance }}<b>Instance:</b> {{ .Labels.instance }}{{ end }}
      {{ if .Annotations.summary }}<b>Summary:</b> {{ .Annotations.summary }}{{ end }}
      {{ if .Annotations.description }}<b>Description:</b> {{ .Annotations.description }}{{ end }}
      <b>Status:</b> {{ .Status }}
      {{ if .DashboardURL }}<a href="{{ .DashboardURL }}">View Dashboard</a>{{ end }}
      {{ if .PanelURL }}<a href="{{ .PanelURL }}">View Panel</a>{{ end }}
      {{ end }}
      {{ end }}

  - orgId: 1
    name: telegram_home_default
    template: |
      {{ define "telegram_home.default" }}
      {{ range .Alerts }}
      üè† <b>Home Alert: {{ .Labels.alertname }}</b>
      {{ if .Labels.severity }}<b>Severity:</b> {{ .Labels.severity }}{{ end }}
      {{ if .Labels.instance }}<b>Instance:</b> {{ .Labels.instance }}{{ end }}
      {{ if .Annotations.summary }}<b>Summary:</b> {{ .Annotations.summary }}{{ end }}
      {{ if .Annotations.description }}<b>Description:</b> {{ .Annotations.description }}{{ end }}
      <b>Status:</b> {{ .Status }}
      {{ end }}
      {{ end }}
