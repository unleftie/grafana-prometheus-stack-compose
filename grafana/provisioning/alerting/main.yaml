# https://grafana.com/docs/grafana/latest/administration/provisioning/#alerting
# https://grafana.com/docs/grafana/latest/alerting/set-up/provision-alerting-resources/file-provisioning
apiVersion: 1

deleteContactPoints:
  - orgId: 1
    name: grafana-default-email

contactPoints:
  - orgId: 1
    name: blackhole
    receivers:
      - uid: blackhole_receiver
        type: email
        disableResolveMessage: true
        settings:
          addresses: blackhole@localhost

  - orgId: 1
    name: telegram
    receivers:
      - uid: telegram_receiver
        type: telegram
        settings:
          bottoken: ${GRAFANA_TELEGRAM_BOT_TOKEN}
          chatid: |
            $GRAFANA_TELEGRAM_CHAT_ID
          message: |
            {{ template "telegram.default" . }}
          parse_mode: HTML
          disable_web_page_preview: true

  - orgId: 1
    name: telegram_no_resolved
    receivers:
      - uid: telegram_no_resolved_receiver
        type: telegram
        disableResolveMessage: true
        settings:
          bottoken: ${GRAFANA_TELEGRAM_BOT_TOKEN}
          chatid: |
            $GRAFANA_TELEGRAM_CHAT_ID
          message: |
            {{ template "telegram.default" . }}
          parse_mode: HTML
          disable_web_page_preview: true

policies:
  - orgId: 1
    receiver: blackhole
    group_by:
      - job
      - alertname
    group_wait: 15s
    group_interval: 15s
    repeat_interval: 24h
    routes:
      - receiver: telegram_no_resolved
        continue: false
        matchers:
          - no_resolved = true
          - severity = error
          - receiver = telegram

      - receiver: telegram
        continue: false
        matchers:
          - severity = error
          - receiver = telegram

templates:
  - orgId: 1
    name: telegram
    template: |
      {{ define "telegram.default" }}
      {{ range .Alerts }}
      {{ if eq .Status "firing" }}ðŸš¨ {{ .Status | toUpper }} ðŸš¨ {{ else }}âœ… {{ .Status | toUpper }} âœ… {{ end }}
      ALERTNAME: {{ .Labels.alertname }}
      {{ if .Annotations.description }}DESCRIPTION: {{ .Annotations.description }}{{ end }}
      {{ if eq .Status "firing" }}STARTS AT: {{ .StartsAt.Local }} {{ else }}ENDS AT: {{ .EndsAt.Local }} {{ end }}
      {{ end }}
      {{ end }}
