# https://grafana.com/docs/grafana/latest/administration/provisioning/#alerting
# https://grafana.com/docs/grafana/latest/alerting/set-up/provision-alerting-resources/file-provisioning
apiVersion: 1

deleteContactPoints:
  - orgId: 1
    name: grafana-default-email

contactPoints:
  - orgId: 1
    name: blackhole
    receivers:
      - uid: blackhole_receiver
        type: email
        disableResolveMessage: true
        settings:
          addresses: blackhole@localhost

  - orgId: 1
    name: telegram
    receivers:
      - uid: telegram_receiver
        type: telegram
        settings:
          bottoken: ${GRAFANA_TELEGRAM_BOT_TOKEN}
          chatid: |
            $GRAFANA_TELEGRAM_CHAT_ID
          message: |
            {{ template "telegram.default" . }}
          parse_mode: HTML
          disable_web_page_preview: true

  - orgId: 1
    name: telegram_no_resolved
    receivers:
      - uid: telegram_no_resolved_receiver
        type: telegram
        disableResolveMessage: true
        settings:
          bottoken: ${GRAFANA_TELEGRAM_BOT_TOKEN}
          chatid: |
            $GRAFANA_TELEGRAM_CHAT_ID
          message: |
            {{ template "telegram.default" . }}
          parse_mode: HTML
          disable_web_page_preview: true

  - orgId: 1
    name: telegram_home
    receivers:
      - uid: telegram_home_receiver
        type: telegram
        settings:
          bottoken: ${GRAFANA_TELEGRAM_BOT_TOKEN}
          chatid: |
            $GRAFANA_TELEGRAM_HOME_CHAT_ID
          message: |
            {{ template "telegram_home.default" . }}
          parse_mode: HTML
          disable_web_page_preview: true

policies:
  - orgId: 1
    receiver: blackhole
    group_by:
      - job
      - alertname
    group_wait: 15s
    group_interval: 15s
    repeat_interval: 24h
    routes:
      - receiver: telegram_no_resolved
        continue: false
        matchers:
          - no_resolved = true
          - severity = error
          - receiver = telegram

      - receiver: telegram
        continue: false
        matchers:
          - severity = error
          - receiver = telegram

      - receiver: telegram_home
        continue: false
        matchers:
          - severity = error
          - receiver = telegram_home

templates:
  - orgId: 1
    name: telegram
    template: |
      {{ define "telegram.default" }}
      {{ range .Alerts }}
      {{ if eq .Status "firing" }}üö® {{ .Status | toUpper }} üö® {{ else }}‚úÖ {{ .Status | toUpper }} ‚úÖ {{ end }}
      ALERTNAME: {{ .Labels.alertname }}
      {{ if .Annotations.summary }}SUMMARY: {{ .Annotations.summary }}{{ end }}
      {{ if .Labels.service }}SERVICE: {{ .Labels.service }}{{ end }}
      {{ if .Labels.env }}ENV: {{ .Labels.env }}{{ end }}
      {{ if eq .Status "firing" }}STARTS AT: {{ .StartsAt.Local }} {{ else }}ENDS AT: {{ .EndsAt.Local }} {{ end }}
      {{ end }}
      {{ end }}

  - orgId: 1
    name: telegram_home
    template: |
      {{ define "telegram_home.default" }}
      {{ range .Alerts }}
      {{ if eq .Status "firing" }}üö® {{ "–¢–†–ò–í–û–ì–ê" }} üö® {{ else }}‚úÖ {{ "–í–Ü–î–ë–Ü–ô –¢–†–ò–í–û–ì–ò" }} ‚úÖ {{ end }}
      {{ if .Annotations.summary }}–ü–†–û–ë–õ–ï–ú–ê: {{ .Annotations.summary }}{{ end }}
      {{ if .Labels.service }}–°–ï–†–í–Ü–°: {{ .Labels.service }}{{ end }}
      {{ if eq .Status "firing" }}–ü–û–ß–ê–¢–û–ö: {{ .StartsAt.Local }} {{ else }}–ó–ê–ö–Ü–ù–ß–ï–ù–ù–Ø: {{ .EndsAt.Local }} {{ end }}
      {{ end }}
      {{ end }}
